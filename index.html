<script>
    const serverUrl = "https://126db9fb-99db-43b2-afe8-020160a29592-00-3ikbo4x79bfza.kirk.replit.dev";
    let map, userMarker, placeMarker;
    const addBtn = document.getElementById("add-btn");
    const saveBtn = document.getElementById("save-btn");
    const locateBtn = document.getElementById("locate-btn");
    const closeBtn = document.getElementById("close-btn");

    // Переменные для иконок должны быть определены в начале
    const pinIcon = L.icon({
        iconUrl: 'pin.png',
        iconSize: [32, 32], 
        iconAnchor: [16, 32], 
        popupAnchor: [0, -32]
    });

    const userIcon = L.icon({
        iconUrl: 'user-marker.png', // Локальный файл изображения для метки после сохранения
        iconSize: [32, 32], 
        iconAnchor: [16, 32], 
        popupAnchor: [0, -32]
    });

    function initMap() {
        map = L.map('map', { 
            zoomControl: false, 
            touchZoom: true,    // Включаем жесты зума
            scrollWheelZoom: true, // Включаем зум колесом мыши
            dragging: true,     // Разрешаем перетаскивание карты
            tap: true           // Разрешаем сенсорные события
        }).setView([55.751244, 37.618423], 13);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        map.locate({ setView: true, maxZoom: 16 });

        map.on('locationfound', (e) => {
            if (!userMarker) {
                userMarker = L.marker(e.latlng, { icon: userIcon }).addTo(map).bindPopup("Вы здесь");
            } else {
                userMarker.setLatLng(e.latlng);
            }
        });

        addBtn.addEventListener("click", () => {
            if (placeMarker) map.removeLayer(placeMarker);

            let center = map.getCenter();
            placeMarker = L.marker(center, { icon: pinIcon }).addTo(map)
                .bindPopup("Переместите и сохраните").openPopup();

            addBtn.style.display = "none";
            saveBtn.style.display = "block";
            closeBtn.style.display = "block"; // Показываем кнопку крестика

            map.setView(center, map.getZoom());
            updateMarkerPosition(center);
        });

        saveBtn.addEventListener("click", async () => {
            let pos = placeMarker.getLatLng();

            try {
                await fetch(`${serverUrl}/add_marker`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ lat: pos.lat, lng: pos.lng })
                });

                alert("Метка сохранена!");
                placeMarker.setIcon(userIcon);

                saveBtn.style.display = "none";
                addBtn.style.display = "block";
                closeBtn.style.display = "none"; // Скрываем крестик

                loadMarkers();
            } catch (error) {
                console.error("Ошибка при отправке данных на сервер:", error);
                alert("Ошибка сохранения метки!");
            }
        });

        locateBtn.addEventListener("click", () => {
            map.locate({ setView: true, maxZoom: 16 });
        });

        map.on('move', () => {
            if (placeMarker) {
                let center = map.getCenter();
                updateMarkerPosition(center);
            }
        });

        loadMarkers();
        setInterval(loadMarkers, 60000);
    }

    function updateMarkerPosition(center) {
        if (placeMarker) {
            placeMarker.setLatLng(center);
        }
    }

    async function loadMarkers() {
        try {
            let response = await fetch(`${serverUrl}/get_markers`);
            let markers = await response.json();

            map.eachLayer(layer => {
                if (layer instanceof L.Marker && layer !== userMarker) {
                    map.removeLayer(layer);
                }
            });

            markers.forEach(({ lat, lng }) => {
                L.marker([lat, lng], { icon: userIcon }).addTo(map);
            });
        } catch (error) {
            console.error("Ошибка загрузки меток:", error);
        }
    }

    document.addEventListener("DOMContentLoaded", initMap);
</script>
